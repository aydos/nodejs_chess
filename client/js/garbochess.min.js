"use strict";function GetFen(){for(var e="",a=0;8>a;a++){0!=a&&(e+="/");for(var o=0,t=0;8>t;t++){var r=g_board[(a+2<<4)+t+4];if(0==r)o++;else{0!=o&&(e+=o),o=0;var i=[" ","p","n","b","r","q","k"," "][7&r];e+=0!=(r&colorWhite)?i.toUpperCase():i}}0!=o&&(e+=o)}return e+=g_toMove==colorWhite?" w":" b",e+=" ",0==g_castleRights?e+="-":(0!=(1&g_castleRights)&&(e+="K"),0!=(2&g_castleRights)&&(e+="Q"),0!=(4&g_castleRights)&&(e+="k"),0!=(8&g_castleRights)&&(e+="q")),e+=" ",e+=-1==g_enPassentSquare?"-":FormatSquare(g_enPassentSquare)}function GetMoveSAN(e,a){var o=255&e,t=e>>8&255;if(e&moveflagCastleKing)return"O-O";if(e&moveflagCastleQueen)return"O-O-O";var r=7&g_board[o],i=["","","N","B","R","Q","K",""][r],g=!1,n=!0,s=!0;null==a&&(a=GenerateValidMoves());for(var _=0;_<a.length;_++){var h=255&a[_],l=a[_]>>8&255;h!=o&&l==t&&(7&g_board[h])==r&&(g=!0,(240&h)==(240&o)&&(n=!1),(15&h)==(15&o)&&(s=!1))}return g?i+=s?FormatSquare(o).charAt(0):n?FormatSquare(o).charAt(1):FormatSquare(o):r==piecePawn&&(0!=g_board[t]||e&moveflagEPC)&&(i+=FormatSquare(o).charAt(0)),(0!=g_board[t]||e&moveflagEPC)&&(i+="x"),i+=FormatSquare(t),e&moveflagPromotion&&(i+=e&moveflagPromoteBishop?"=B":e&moveflagPromoteKnight?"=N":e&moveflagPromoteQueen?"=Q":"=R"),MakeMove(e),g_inCheck&&(i+=0==GenerateValidMoves().length?"#":"+"),UnmakeMove(e),i}function FormatSquare(e){var a=["a","b","c","d","e","f","g","h"];return a[(15&e)-4]+(9-(e>>4)+1)}function FormatMove(e){var a=FormatSquare(255&e)+FormatSquare(e>>8&255);return e&moveflagPromotion&&(a+=e&moveflagPromoteBishop?"b":e&moveflagPromoteKnight?"n":e&moveflagPromoteQueen?"q":"r"),a}function GetMoveFromString(e){for(var a=GenerateValidMoves(),o=0;o<a.length;o++)if(FormatMove(a[o])==e)return a[o];alert("busted! ->"+e+" fen:"+GetFen())}function PVFromHash(e,a){if(0==a)return"";if(0==e)return g_inCheck?"checkmate":"stalemate";var o=" "+GetMoveSAN(e);MakeMove(e);var t=g_hashTable[g_hashKeyLow&g_hashMask];return null!=t&&t.lock==g_hashKeyHigh&&null!=t.bestMove&&(o+=PVFromHash(t.bestMove,a-1)),UnmakeMove(e),o}function Search(e,a,o){var t=minEval,r=maxEval;g_globalPly++,g_nodeCount=0,g_qNodeCount=0,g_searchValid=!0;var i,g=0;g_startTime=(new Date).getTime();var n;for(n=1;a>=n&&g_searchValid;n++){var s=AlphaBeta(n,0,t,r);if(!g_searchValid)break;i=s,i>t&&r>i?(t=i-500,r=i+500,minEval>t&&(t=minEval),r>maxEval&&(r=maxEval)):t!=minEval&&(t=minEval,r=maxEval,n--),null!=g_hashTable[g_hashKeyLow&g_hashMask]&&(g=g_hashTable[g_hashKeyLow&g_hashMask].bestMove),null!=o&&o(g,i,(new Date).getTime()-g_startTime,n)}null!=e&&e(g,i,(new Date).getTime()-g_startTime,n-1)}function PawnEval(e){for(var a=(1|e)<<4,o=g_pieceList[a++];0!=o;)o=g_pieceList[a++]}function Mobility(e){var a,o,t,r,i=0,g=8==e?16:8,n=8==e?g_mobUnit[0]:g_mobUnit[1];for(t=-3,r=(2|e)<<4,a=g_pieceList[r++];0!=a;)t+=n[g_board[a+31]],t+=n[g_board[a+33]],t+=n[g_board[a+14]],t+=n[g_board[a-14]],t+=n[g_board[a-31]],t+=n[g_board[a-33]],t+=n[g_board[a+18]],t+=n[g_board[a-18]],a=g_pieceList[r++];for(i+=65*t,t=-4,r=(3|e)<<4,a=g_pieceList[r++];0!=a;){for(o=a-15;0==g_board[o];)o-=15,t++;if(g_board[o]&g&&(t++,!(g_board[o]&piecePawn))){for(o-=15;0==g_board[o];)o-=15;t+=n[g_board[o]]<<2}for(o=a-17;0==g_board[o];)o-=17,t++;if(g_board[o]&g&&(t++,!(g_board[o]&piecePawn))){for(o-=17;0==g_board[o];)o-=17;t+=n[g_board[o]]<<2}for(o=a+15;0==g_board[o];)o+=15,t++;if(g_board[o]&g&&(t++,!(g_board[o]&piecePawn))){for(o+=15;0==g_board[o];)o+=15;t+=n[g_board[o]]<<2}for(o=a+17;0==g_board[o];)o+=17,t++;if(g_board[o]&g&&(t++,!(g_board[o]&piecePawn))){for(o+=17;0==g_board[o];)o+=17;t+=n[g_board[o]]<<2}a=g_pieceList[r++]}for(i+=44*t,t=-4,r=(4|e)<<4,a=g_pieceList[r++];0!=a;){for(o=a-1;0==g_board[o];)o--,t++;for(g_board[o]&g&&t++,o=a+1;0==g_board[o];)o++,t++;for(g_board[o]&g&&t++,o=a+16;0==g_board[o];)o+=16,t++;for(g_board[o]&g&&t++,o=a-16;0==g_board[o];)o-=16,t++;g_board[o]&g&&t++,a=g_pieceList[r++]}for(i+=25*t,t=-2,r=(5|e)<<4,a=g_pieceList[r++];0!=a;){for(o=a-15;0==g_board[o];)o-=15,t++;for(g_board[o]&g&&t++,o=a-17;0==g_board[o];)o-=17,t++;for(g_board[o]&g&&t++,o=a+15;0==g_board[o];)o+=15,t++;for(g_board[o]&g&&t++,o=a+17;0==g_board[o];)o+=17,t++;for(g_board[o]&g&&t++,o=a-1;0==g_board[o];)o--,t++;for(g_board[o]&g&&t++,o=a+1;0==g_board[o];)o++,t++;for(g_board[o]&g&&t++,o=a+16;0==g_board[o];)o+=16,t++;for(g_board[o]&g&&t++,o=a-16;0==g_board[o];)o-=16,t++;g_board[o]&g&&t++,a=g_pieceList[r++]}return i+=22*t}function Evaluate(){var e=g_baseEval,a=0;0==g_pieceList[pieceQueen<<4]&&(a-=pieceSquareAdj[pieceKing][g_pieceList[(colorWhite|pieceKing)<<4]]),0==g_pieceList[(colorWhite|pieceQueen)<<4]&&(a+=pieceSquareAdj[pieceKing][flipTable[g_pieceList[pieceKing<<4]]]),g_pieceCount[pieceBishop]>=2&&(a-=500),g_pieceCount[pieceBishop|colorWhite]>=2&&(a+=500);var o=Mobility(8)-Mobility(0);return 0==g_toMove?(e-=o,e-=a):(e+=o,e+=a),e}function ScoreMove(e){var a,o=e>>8&255,t=7&g_board[o],r=g_board[255&e];if(0!=t){var i=7&r;a=(t<<5)-i}else a=historyTable[15&r][o];return a}function QSearch(e,a,o){g_qNodeCount++;var t=g_inCheck?minEval+1:Evaluate();if(t>=a)return t;t>e&&(e=t);var r=new Array,i=new Array,g=g_inCheck;if(g){GenerateCaptureMoves(r,null),GenerateAllMoves(r);for(var n=0;n<r.length;n++)i[n]=ScoreMove(r[n])}else{GenerateCaptureMoves(r,null);for(var n=0;n<r.length;n++){var s=7&g_board[r[n]>>8&255],_=7&g_board[255&r[n]];i[n]=(s<<5)-_}}for(var n=0;n<r.length;n++){for(var h=n,l=r.length-1;l>n;l--)i[l]>i[h]&&(h=l);var v=r[n];r[n]=r[h],r[h]=v;var c=i[n];if(i[n]=i[h],i[h]=c,(g||See(r[n]))&&MakeMove(r[n])){var d=-QSearch(-a,-e,o-1);if(UnmakeMove(r[n]),d>t){if(d>=a)return d;d>e&&(e=d),t=d}}}return t}function StoreHash(e,a,o,t,r){e>=maxMateBuffer?e+=r:minMateBuffer>=e&&(e-=r),g_hashTable[g_hashKeyLow&g_hashMask]=new HashEntry(g_hashKeyHigh,e,a,o,t)}function IsHashMoveValid(e){var a=255&e,o=e>>8&255,t=g_board[a],r=7&t;if(piecePawn>r||r>pieceKing)return!1;if(g_toMove!=(8&t))return!1;if(0!=g_board[o]&&g_toMove==(8&g_board[o]))return!1;if(r==piecePawn){if(e&moveflagEPC)return!1;var i=o-a;if(g_toMove==colorWhite!=0>i)return!1;var g=240&o;if((144==g&&!g_toMove||32==g&&g_toMove)!=(e&moveflagPromotion))return!1;if(-16==i||16==i)return 0==g_board[o];if(-15==i||-17==i||15==i||17==i)return 0!=g_board[o];if(-32==i){if(96!=g)return!1;if(0!=g_board[o])return!1;if(0!=g_board[a-16])return!1}else{if(32!=i)return!1;if(80!=g)return!1;if(0!=g_board[o])return!1;if(0!=g_board[a+16])return!1}return!0}return e>>16?!1:IsSquareAttackableFrom(o,a)}function IsRepDraw(){var e=g_moveCount-1-g_move50;e=0>e?0:e;for(var a=g_moveCount-5;a>=e;a-=2)if(g_repMoveStack[a]==g_hashKeyLow)return!0;return!1}function MovePicker(e,a,o,t){this.hashMove=e,this.depth=a,this.killer1=o,this.killer2=t,this.moves=new Array,this.losingCaptures=null,this.moveCount=0,this.atMove=-1,this.moveScores=null,this.stage=0,this.nextMove=function(){if(++this.atMove==this.moveCount){if(this.stage++,1==this.stage&&(null!=this.hashMove&&IsHashMoveValid(e)&&(this.moves[0]=e,this.moveCount=1),1!=this.moveCount&&(this.hashMove=null,this.stage++)),2==this.stage){GenerateCaptureMoves(this.moves,null),this.moveCount=this.moves.length,this.moveScores=new Array(this.moveCount);for(var a=this.atMove;a<this.moveCount;a++){var o=7&g_board[this.moves[a]>>8&255],t=7&g_board[255&this.moves[a]];this.moveScores[a]=(o<<5)-t}this.atMove==this.moveCount&&this.stage++}if(3==this.stage&&(IsHashMoveValid(this.killer1)&&this.killer1!=this.hashMove?(this.moves[this.moves.length]=this.killer1,this.moveCount=this.moves.length):(this.killer1=0,this.stage++)),4==this.stage&&(IsHashMoveValid(this.killer2)&&this.killer2!=this.hashMove?(this.moves[this.moves.length]=this.killer2,this.moveCount=this.moves.length):(this.killer2=0,this.stage++)),5==this.stage){GenerateAllMoves(this.moves),this.moveCount=this.moves.length;for(var a=this.atMove;a<this.moveCount;a++)this.moveScores[a]=ScoreMove(this.moves[a]);this.atMove==this.moveCount&&this.stage++}if(6==this.stage){if(null!=this.losingCaptures){for(var a=0;a<this.losingCaptures.length;a++)this.moves[this.moves.length]=this.losingCaptures[a];for(var a=this.atMove;a<this.moveCount;a++)this.moveScores[a]=ScoreMove(this.moves[a]);this.moveCount=this.moves.length}this.atMove==this.moveCount&&this.stage++}if(7==this.stage)return 0}for(var r=this.atMove,i=this.atMove+1;i<this.moveCount;i++)this.moveScores[i]>this.moveScores[r]&&(r=i);if(r!=this.atMove){var g=this.moves[this.atMove];this.moves[this.atMove]=this.moves[r],this.moves[r]=g;var n=this.moveScores[this.atMove];this.moveScores[this.atMove]=this.moveScores[r],this.moveScores[r]=n}var s=this.moves[this.atMove];return this.stage>1&&s==this.hashMove||this.stage>3&&s==this.killer1||this.stage>4&&s==this.killer2?this.nextMove():2!=this.stage||See(s)?this.moves[this.atMove]:(null==this.losingCaptures&&(this.losingCaptures=new Array),this.losingCaptures[this.losingCaptures.length]=s,this.nextMove())}}function AllCutNode(e,a,o,t){if(0>=e)return QSearch(o-1,o,0);if(127==(127&g_nodeCount)&&(new Date).getTime()-g_startTime>g_timeout)return g_searchValid=!1,o-1;if(g_nodeCount++,IsRepDraw())return 0;if(minEval+a>=o)return o;if(o>maxEval-(a+1))return o-1;var r=null,i=g_hashTable[g_hashKeyLow&g_hashMask];if(null!=i&&i.lock==g_hashKeyHigh&&(r=i.bestMove,i.hashDepth>=e)){var g=i.value;if(g>=maxMateBuffer?g-=a:minMateBuffer>=g&&(g+=a),i.flags==hashflagExact)return g;if(i.flags==hashflagAlpha&&o>g)return g;if(i.flags==hashflagBeta&&g>=o)return g}if(!g_inCheck&&t&&o>minMateBuffer&&maxMateBuffer>o){if(null==r&&4>e){var n=2500+200*e;if(o-n>g_baseEval){var s=o-n,_=QSearch(s-1,s,0);if(s>_)return _}}if(e>1&&g_baseEval>=o-(e>=4?2500:0)&&(0!=g_pieceCount[pieceBishop|g_toMove]||0!=g_pieceCount[pieceKnight|g_toMove]||0!=g_pieceCount[pieceRook|g_toMove]||0!=g_pieceCount[pieceQueen|g_toMove])){var h=3+(e>=5?1:e/4);g_baseEval-o>1500&&h++,g_toMove=8-g_toMove,g_baseEval=-g_baseEval,g_hashKeyLow^=g_zobristBlackLow,g_hashKeyHigh^=g_zobristBlackHigh;var l=-AllCutNode(e-h,a+1,-(o-1),!1);if(g_hashKeyLow^=g_zobristBlackLow,g_hashKeyHigh^=g_zobristBlackHigh,g_toMove=8-g_toMove,g_baseEval=-g_baseEval,l>=o)return o}}for(var v=!1,c=minEval-1,d=new MovePicker(r,a,g_killers[a][0],g_killers[a][1]);;){var b=d.nextMove();if(0==b)break;var u=e-1;if(MakeMove(b)){var l,f=!0;if(g_inCheck)u++;else{var p=u-(d.atMove>14?2:1);5==d.stage&&d.atMove>5&&e>=3&&(l=-AllCutNode(p,a+1,-(o-1),!0),f=l>=o)}if(f&&(l=-AllCutNode(u,a+1,-(o-1),!0)),v=!0,UnmakeMove(b),!g_searchValid)return o-1;if(l>c){if(l>=o){var m=b>>8&255;if(0==g_board[m]){var M=15&g_board[255&b];historyTable[M][m]+=e*e,historyTable[M][m]>32767&&(historyTable[M][m]>>=1),g_killers[a][0]!=b&&(g_killers[a][1]=g_killers[a][0],g_killers[a][0]=b)}return StoreHash(l,hashflagBeta,e,b,a),l}c=l,r=b}}}return v?(StoreHash(c,hashflagAlpha,e,r,a),c):g_inCheck?minEval+a:0}function AlphaBeta(e,a,o,t){if(0>=e)return QSearch(o,t,0);if(g_nodeCount++,a>0&&IsRepDraw())return 0;var r=o;if(o=minEval+a>o?o:minEval+a,t=t>maxEval-(a+1)?t:maxEval-(a+1),o>=t)return o;var i=null,g=hashflagAlpha,n=g_hashTable[g_hashKeyLow&g_hashMask];null!=n&&n.lock==g_hashKeyHigh&&(i=n.bestMove);for(var s=g_inCheck,_=!1,h=minEval,l=new MovePicker(i,a,g_killers[a][0],g_killers[a][1]);;){var v=l.nextMove();if(0==v)break;var c=e-1;if(MakeMove(v)){g_inCheck&&c++;var d;if(_?(d=-AllCutNode(c,a+1,-o,!0),d>o&&(d=-AlphaBeta(c,a+1,-t,-o))):d=-AlphaBeta(c,a+1,-t,-o),_=!0,UnmakeMove(v),!g_searchValid)return o;if(d>h){if(d>=t){var b=v>>8&255;if(0==g_board[b]){var u=15&g_board[255&v];historyTable[u][b]+=e*e,historyTable[u][b]>32767&&(historyTable[u][b]>>=1),g_killers[a][0]!=v&&(g_killers[a][1]=g_killers[a][0],g_killers[a][0]=v)}return StoreHash(d,hashflagBeta,e,v,a),d}d>r&&(g=hashflagExact,o=d),h=d,i=v}}}return _?(StoreHash(h,g,e,i,a),h):s?minEval+a:0}function MT(){var e=624,a=397,o=[0,2567483615];this.mt=new Array(e),this.mti=e+1,this.setSeed=function(){var a=arguments;switch(a.length){case 1:if(a[0].constructor===Number){this.mt[0]=a[0];for(var o=1;e>o;++o){var t=this.mt[o-1]^this.mt[o-1]>>>30;this.mt[o]=(1812433253*((4294901760&t)>>>16)<<16)+1812433253*(65535&t)+o}return void(this.mti=e)}this.setSeed(19650218);for(var r=a[0].length,o=1,i=0,g=e>r?e:r;0!=g;--g){var t=this.mt[o-1]^this.mt[o-1]>>>30;this.mt[o]=(this.mt[o]^(1664525*((4294901760&t)>>>16)<<16)+1664525*(65535&t))+a[0][i]+i,++o>=e&&(this.mt[0]=this.mt[e-1],o=1),++i>=r&&(i=0)}for(var g=e-1;0!=g;--g){var t=this.mt[o-1]^this.mt[o-1]>>>30;this.mt[o]=(this.mt[o]^(1566083941*((4294901760&t)>>>16)<<16)+1566083941*(65535&t))-o,++o>=e&&(this.mt[0]=this.mt[e-1],o=1)}return void(this.mt[0]=2147483648);default:for(var n=new Array,o=0;o<a.length;++o)n.push(a[o]);return void this.setSeed(n)}},this.setSeed(464384013),this.next=function(t){if(this.mti>=e){for(var r=0,i=0;e-a>i;++i)r=2147483648&this.mt[i]|2147483647&this.mt[i+1],this.mt[i]=this.mt[i+a]^r>>>1^o[1&r];for(var i=e-a;e-1>i;++i)r=2147483648&this.mt[i]|2147483647&this.mt[i+1],this.mt[i]=this.mt[i+(a-e)]^r>>>1^o[1&r];r=2147483648&this.mt[e-1]|2147483647&this.mt[0],this.mt[e-1]=this.mt[a-1]^r>>>1^o[1&r],this.mti=0}var g=this.mt[this.mti++];return g^=g>>>11,g^=g<<7&2636928640,g^=g<<15&4022730752,g^=g>>>18,g>>>32-t&4294967295}}function HashEntry(e,a,o,t,r){this.lock=e,this.value=a,this.flags=o,this.hashDepth=t,this.bestMove=r}function MakeSquare(e,a){return e+2<<4|a+4}function MakeTable(e){for(var a=new Array(256),o=0;256>o;o++)a[o]=0;for(var t=0;8>t;t++)for(var r=0;8>r;r++)a[MakeSquare(t,r)]=e[8*t+r];return a}function ResetGame(){g_killers=new Array(128);for(var e=0;128>e;e++)g_killers[e]=[0,0];g_hashTable=new Array(g_hashSize);for(var e=0;32>e;e++){historyTable[e]=new Array(256);for(var a=0;256>a;a++)historyTable[e][a]=0}var o=new MT(464384013);g_zobristLow=new Array(256),g_zobristHigh=new Array(256);for(var e=0;256>e;e++){g_zobristLow[e]=new Array(16),g_zobristHigh[e]=new Array(16);for(var a=0;16>a;a++)g_zobristLow[e][a]=o.next(32),g_zobristHigh[e][a]=o.next(32)}g_zobristBlackLow=o.next(32),g_zobristBlackHigh=o.next(32);for(var t=0;8>t;t++)for(var r=0;8>r;r++){var i=MakeSquare(t,r);flipTable[i]=MakeSquare(7-t,r)}pieceSquareAdj[piecePawn]=MakeTable(pawnAdj),pieceSquareAdj[pieceKnight]=MakeTable(knightAdj),pieceSquareAdj[pieceBishop]=MakeTable(bishopAdj),pieceSquareAdj[pieceRook]=MakeTable(rookAdj),pieceSquareAdj[pieceQueen]=MakeTable(emptyAdj),pieceSquareAdj[pieceKing]=MakeTable(kingAdj);for(var g=[[],[],g_knightDeltas,g_bishopDeltas,g_rookDeltas,g_queenDeltas,g_queenDeltas],e=0;256>e;e++)g_vectorDelta[e]=new Object,g_vectorDelta[e].delta=0,g_vectorDelta[e].pieceMask=new Array(2),g_vectorDelta[e].pieceMask[0]=0,g_vectorDelta[e].pieceMask[1]=0;for(var t=0;128>t;t+=16)for(var r=0;8>r;r++){var i=t|r,n=i-(i-17)+128;g_vectorDelta[n].pieceMask[colorWhite>>3]|=1<<piecePawn,n=i-(i-15)+128,g_vectorDelta[n].pieceMask[colorWhite>>3]|=1<<piecePawn,n=i-(i+17)+128,g_vectorDelta[n].pieceMask[0]|=1<<piecePawn,n=i-(i+15)+128,g_vectorDelta[n].pieceMask[0]|=1<<piecePawn;for(var e=pieceKnight;pieceKing>=e;e++)for(var s=0;s<g[e].length;s++)for(var _=i+g[e][s];!(136&_);){n=i-_+128,g_vectorDelta[n].pieceMask[colorWhite>>3]|=1<<e,g_vectorDelta[n].pieceMask[0]|=1<<e;var h=-1;if(_>i&&(h=1),(240&i)==(240&_)?g_vectorDelta[n].delta=1*h:(15&i)==(15&_)?g_vectorDelta[n].delta=16*h:i%15==_%15?g_vectorDelta[n].delta=15*h:i%17==_%17&&(g_vectorDelta[n].delta=17*h),e==pieceKnight){g_vectorDelta[n].delta=g[e][s];break}if(e==pieceKing)break;_+=g[e][s]}}InitializeEval(),InitializeFromFen("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}function InitializeEval(){g_mobUnit=new Array(2);for(var e=0;2>e;e++){g_mobUnit[e]=new Array;var a=0==e?16:8,o=0==e?8:16;g_mobUnit[e][0]=1,g_mobUnit[e][128]=0,g_mobUnit[e][a|piecePawn]=1,g_mobUnit[e][a|pieceBishop]=2,g_mobUnit[e][a|pieceKnight]=2,g_mobUnit[e][a|pieceRook]=4,g_mobUnit[e][a|pieceQueen]=6,g_mobUnit[e][a|pieceKing]=6,g_mobUnit[e][o|piecePawn]=0,g_mobUnit[e][o|pieceBishop]=0,g_mobUnit[e][o|pieceKnight]=0,g_mobUnit[e][o|pieceRook]=0,g_mobUnit[e][o|pieceQueen]=0,g_mobUnit[e][o|pieceKing]=0}}function SetHash(){var e=new Object;e.hashKeyLow=0,e.hashKeyHigh=0;for(var a=0;256>a;a++){var o=g_board[a];24&o&&(e.hashKeyLow^=g_zobristLow[a][15&o],e.hashKeyHigh^=g_zobristHigh[a][15&o])}return g_toMove||(e.hashKeyLow^=g_zobristBlackLow,e.hashKeyHigh^=g_zobristBlackHigh),e}function InitializeFromFen(e){for(var a=e.split(" "),o=0;256>o;o++)g_board[o]=128;for(var t=0,r=0,i=a[0],o=0;o<i.length;o++){var g=i.charAt(o);if("/"==g)t++,r=0;else if(g>="0"&&"9">=g)for(var n=0;n<parseInt(g);n++)g_board[MakeSquare(t,r)]=0,r++;else{var s=g>="a"&&"z">=g,_=s?colorBlack:colorWhite;switch(s||(g=i.toLowerCase().charAt(o)),g){case"p":_|=piecePawn;break;case"b":_|=pieceBishop;break;case"n":_|=pieceKnight;break;case"r":_|=pieceRook;break;case"q":_|=pieceQueen;break;case"k":_|=pieceKing}g_board[MakeSquare(t,r)]=_,r++}}InitializePieceList(),g_toMove="w"==a[1].charAt(0)?colorWhite:0;var h=8-g_toMove;if(g_castleRights=0,-1!=a[2].indexOf("K")){if(g_board[MakeSquare(7,4)]!=(pieceKing|colorWhite)||g_board[MakeSquare(7,7)]!=(pieceRook|colorWhite))return"Invalid FEN: White kingside castling not allowed";g_castleRights|=1}if(-1!=a[2].indexOf("Q")){if(g_board[MakeSquare(7,4)]!=(pieceKing|colorWhite)||g_board[MakeSquare(7,0)]!=(pieceRook|colorWhite))return"Invalid FEN: White queenside castling not allowed";g_castleRights|=2}if(-1!=a[2].indexOf("k")){if(g_board[MakeSquare(0,4)]!=(pieceKing|colorBlack)||g_board[MakeSquare(0,7)]!=(pieceRook|colorBlack))return"Invalid FEN: Black kingside castling not allowed";g_castleRights|=4}if(-1!=a[2].indexOf("q")){if(g_board[MakeSquare(0,4)]!=(pieceKing|colorBlack)||g_board[MakeSquare(0,0)]!=(pieceRook|colorBlack))return"Invalid FEN: Black queenside castling not allowed";g_castleRights|=8}if(g_enPassentSquare=-1,-1==a[3].indexOf("-")){var r=a[3].charAt(0).charCodeAt()-"a".charCodeAt(),t=8-(a[3].charAt(1).charCodeAt()-"0".charCodeAt());g_enPassentSquare=MakeSquare(t,r)}var l=SetHash();g_hashKeyLow=l.hashKeyLow,g_hashKeyHigh=l.hashKeyHigh,g_baseEval=0;for(var o=0;256>o;o++)g_board[o]&colorWhite?(g_baseEval+=pieceSquareAdj[7&g_board[o]][o],g_baseEval+=materialTable[7&g_board[o]]):g_board[o]&colorBlack&&(g_baseEval-=pieceSquareAdj[7&g_board[o]][flipTable[o]],g_baseEval-=materialTable[7&g_board[o]]);return g_toMove||(g_baseEval=-g_baseEval),g_move50=0,g_inCheck=IsSquareAttackable(g_pieceList[(g_toMove|pieceKing)<<4],h),IsSquareAttackable(g_pieceList[(h|pieceKing)<<4],g_toMove)?"Invalid FEN: Can capture king":0==GenerateValidMoves().length?g_inCheck?"Checkmate":"Stalemate":""}function InitializePieceList(){for(var e=0;16>e;e++){g_pieceCount[e]=0;for(var a=0;16>a;a++)g_pieceList[e<<4|a]=0}for(var e=0;256>e;e++)if(g_pieceIndex[e]=0,g_board[e]&(colorWhite|colorBlack)){var o=15&g_board[e];g_pieceList[o<<4|g_pieceCount[o]]=e,g_pieceIndex[e]=g_pieceCount[o],g_pieceCount[o]++}}function MakeMove(e){var a=g_toMove>>3,o=8-g_toMove,t=16711680&e,r=e>>8&255,i=255&e,g=g_board[r],n=g_board[i],s=r;if(t&moveflagEPC&&(s=a?r+16:r-16,g=g_board[s],g_board[s]=pieceEmpty),g_moveUndoStack[g_moveCount]=new UndoHistory(g_enPassentSquare,g_castleRights,g_inCheck,g_baseEval,g_hashKeyLow,g_hashKeyHigh,g_move50,g),g_moveCount++,g_enPassentSquare=-1,t)if(t&moveflagCastleKing){if(IsSquareAttackable(i+1,o)||IsSquareAttackable(i+2,o))return g_moveCount--,!1;var _=g_board[r+1];g_hashKeyLow^=g_zobristLow[r+1][15&_],g_hashKeyHigh^=g_zobristHigh[r+1][15&_],g_hashKeyLow^=g_zobristLow[r-1][15&_],g_hashKeyHigh^=g_zobristHigh[r-1][15&_],g_board[r-1]=_,g_board[r+1]=pieceEmpty,g_baseEval-=pieceSquareAdj[7&_][0==a?flipTable[r+1]:r+1],g_baseEval+=pieceSquareAdj[7&_][0==a?flipTable[r-1]:r-1];var h=g_pieceIndex[r+1];g_pieceIndex[r-1]=h,g_pieceList[(15&_)<<4|h]=r-1}else if(t&moveflagCastleQueen){if(IsSquareAttackable(i-1,o)||IsSquareAttackable(i-2,o))return g_moveCount--,!1;var _=g_board[r-2];g_hashKeyLow^=g_zobristLow[r-2][15&_],g_hashKeyHigh^=g_zobristHigh[r-2][15&_],g_hashKeyLow^=g_zobristLow[r+1][15&_],g_hashKeyHigh^=g_zobristHigh[r+1][15&_],g_board[r+1]=_,g_board[r-2]=pieceEmpty,g_baseEval-=pieceSquareAdj[7&_][0==a?flipTable[r-2]:r-2],g_baseEval+=pieceSquareAdj[7&_][0==a?flipTable[r+1]:r+1];var h=g_pieceIndex[r-2];g_pieceIndex[r+1]=h,g_pieceList[(15&_)<<4|h]=r+1}if(g){var l=15&g;g_pieceCount[l]--;var v=g_pieceList[l<<4|g_pieceCount[l]];g_pieceIndex[v]=g_pieceIndex[s],g_pieceList[l<<4|g_pieceIndex[v]]=v,g_pieceList[l<<4|g_pieceCount[l]]=0,g_baseEval+=materialTable[7&g],g_baseEval+=pieceSquareAdj[7&g][a?flipTable[s]:s],g_hashKeyLow^=g_zobristLow[s][l],g_hashKeyHigh^=g_zobristHigh[s][l],g_move50=0}else if((7&n)==piecePawn){var c=r-i;0>c&&(c=-c),c>16&&(g_enPassentSquare=a?r+16:r-16),g_move50=0}if(g_hashKeyLow^=g_zobristLow[i][15&n],g_hashKeyHigh^=g_zobristHigh[i][15&n],g_hashKeyLow^=g_zobristLow[r][15&n],g_hashKeyHigh^=g_zobristHigh[r][15&n],g_hashKeyLow^=g_zobristBlackLow,g_hashKeyHigh^=g_zobristBlackHigh,g_castleRights&=g_castleRightsMask[i]&g_castleRightsMask[r],g_baseEval-=pieceSquareAdj[7&n][0==a?flipTable[i]:i],g_pieceIndex[r]=g_pieceIndex[i],g_pieceList[(15&n)<<4|g_pieceIndex[r]]=r,t&moveflagPromotion){var d=-8&n;d|=t&moveflagPromoteKnight?pieceKnight:t&moveflagPromoteQueen?pieceQueen:t&moveflagPromoteBishop?pieceBishop:pieceRook,g_hashKeyLow^=g_zobristLow[r][15&n],g_hashKeyHigh^=g_zobristHigh[r][15&n],g_board[r]=d,g_hashKeyLow^=g_zobristLow[r][15&d],g_hashKeyHigh^=g_zobristHigh[r][15&d],g_baseEval+=pieceSquareAdj[7&d][0==a?flipTable[r]:r],g_baseEval-=materialTable[piecePawn],g_baseEval+=materialTable[7&d];var b=15&n,u=15&d;g_pieceCount[b]--;var f=g_pieceList[b<<4|g_pieceCount[b]];g_pieceIndex[f]=g_pieceIndex[r],g_pieceList[b<<4|g_pieceIndex[f]]=f,g_pieceList[b<<4|g_pieceCount[b]]=0,g_pieceIndex[r]=g_pieceCount[u],g_pieceList[u<<4|g_pieceIndex[r]]=r,g_pieceCount[u]++}else g_board[r]=g_board[i],g_baseEval+=pieceSquareAdj[7&n][0==a?flipTable[r]:r];if(g_board[i]=pieceEmpty,g_toMove=o,g_baseEval=-g_baseEval,(7&n)==pieceKing||g_inCheck){if(IsSquareAttackable(g_pieceList[(pieceKing|8-g_toMove)<<4],o))return UnmakeMove(e),!1}else{var p=g_pieceList[(pieceKing|8-g_toMove)<<4];if(ExposesCheck(i,p))return UnmakeMove(e),!1;if(s!=r&&ExposesCheck(s,p))return UnmakeMove(e),!1}if(g_inCheck=!1,moveflagEPC>=t){var m=g_pieceList[(pieceKing|g_toMove)<<4];g_inCheck=IsSquareAttackableFrom(m,r),g_inCheck||(g_inCheck=ExposesCheck(i,m),g_inCheck||s!=r&&(g_inCheck=ExposesCheck(s,m)))}else g_inCheck=IsSquareAttackable(g_pieceList[(pieceKing|g_toMove)<<4],8-g_toMove);return g_repMoveStack[g_moveCount-1]=g_hashKeyLow,g_move50++,!0}function UnmakeMove(e){g_toMove=8-g_toMove,g_baseEval=-g_baseEval,g_moveCount--,g_enPassentSquare=g_moveUndoStack[g_moveCount].ep,g_castleRights=g_moveUndoStack[g_moveCount].castleRights,g_inCheck=g_moveUndoStack[g_moveCount].inCheck,g_baseEval=g_moveUndoStack[g_moveCount].baseEval,g_hashKeyLow=g_moveUndoStack[g_moveCount].hashKeyLow,g_hashKeyHigh=g_moveUndoStack[g_moveCount].hashKeyHigh,g_move50=g_moveUndoStack[g_moveCount].move50;var a=16711680&e,o=g_moveUndoStack[g_moveCount].captured,t=e>>8&255,r=255&e,i=g_board[t];if(a)if(a&moveflagCastleKing){var g=g_board[t-1];g_board[t+1]=g,g_board[t-1]=pieceEmpty;var n=g_pieceIndex[t-1];g_pieceIndex[t+1]=n,g_pieceList[(15&g)<<4|n]=t+1}else if(a&moveflagCastleQueen){var g=g_board[t+1];g_board[t-2]=g,g_board[t+1]=pieceEmpty;var n=g_pieceIndex[t+1];g_pieceIndex[t-2]=n,g_pieceList[(15&g)<<4|n]=t-2}if(a&moveflagPromotion){i=-8&g_board[t]|piecePawn,g_board[r]=i;var s=15&g_board[r],_=15&g_board[t];g_pieceCount[_]--;var h=g_pieceList[_<<4|g_pieceCount[_]];g_pieceIndex[h]=g_pieceIndex[t],g_pieceList[_<<4|g_pieceIndex[h]]=h,g_pieceList[_<<4|g_pieceCount[_]]=0,g_pieceIndex[t]=g_pieceCount[s],g_pieceList[s<<4|g_pieceIndex[t]]=t,g_pieceCount[s]++}else g_board[r]=g_board[t];var l=t;if(a&moveflagEPC&&(l=g_toMove==colorWhite?t+16:t-16,g_board[t]=pieceEmpty),g_board[l]=o,g_pieceIndex[r]=g_pieceIndex[t],g_pieceList[(15&i)<<4|g_pieceIndex[r]]=r,o){var v=15&o;g_pieceIndex[l]=g_pieceCount[v],g_pieceList[v<<4|g_pieceCount[v]]=l,g_pieceCount[v]++}}function ExposesCheck(e,a){var o=a-e+128;if(0!=(g_vectorDelta[o].pieceMask[0]&1<<pieceQueen)){for(var t=g_vectorDelta[o].delta,r=a+t;0==g_board[r];)r+=t;var i=g_board[r];if(0==(i&(24^g_board[a])&24))return!1;var g=r-a+128;return 0!=(g_vectorDelta[g].pieceMask[i>>3&1]&1<<(7&i))}return!1}function IsSquareOnPieceLine(e,a){var o=a-e+128,t=g_board[a];return g_vectorDelta[o].pieceMask[t>>3&1]&1<<(7&t)?!0:!1}function IsSquareAttackableFrom(e,a){var o=a-e+128,t=g_board[a];if(g_vectorDelta[o].pieceMask[t>>3&1]&1<<(7&t)){var r=g_vectorDelta[o].delta;do if(a+=r,a==e)return!0;while(0==g_board[a])}return!1}function IsSquareAttackable(e,a){var o=a?-16:16,t=1|(a?colorWhite:colorBlack);if(g_board[e-(o-1)]==t)return!0;if(g_board[e-(o+1)]==t)return!0;for(var r=2;6>=r;r++)for(var i=(a|r)<<4,g=g_pieceList[i];0!=g;){if(IsSquareAttackableFrom(e,g))return!0;g=g_pieceList[++i]}return!1}function GenerateMove(e,a){return e|a<<8}function GenerateMove(e,a,o){return e|a<<8|o}function GenerateValidMoves(){var e=new Array,a=new Array;GenerateCaptureMoves(a,null),GenerateAllMoves(a);for(var o=a.length-1;o>=0;o--)MakeMove(a[o])&&(e[e.length]=a[o],UnmakeMove(a[o]));return e}function GenerateAllMoves(e){var a,o,t;for(t=(1|g_toMove)<<4,a=g_pieceList[t++];0!=a;)GeneratePawnMoves(e,a),a=g_pieceList[t++];for(t=(2|g_toMove)<<4,a=g_pieceList[t++];0!=a;)o=a+31,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a+33,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a+14,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a-14,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a-31,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a-33,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a+18,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a-18,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),a=g_pieceList[t++];for(t=(3|g_toMove)<<4,a=g_pieceList[t++];0!=a;){for(o=a-15;0==g_board[o];)e[e.length]=GenerateMove(a,o),o-=15;for(o=a-17;0==g_board[o];)e[e.length]=GenerateMove(a,o),o-=17;for(o=a+15;0==g_board[o];)e[e.length]=GenerateMove(a,o),o+=15;for(o=a+17;0==g_board[o];)e[e.length]=GenerateMove(a,o),o+=17;a=g_pieceList[t++]}for(t=(4|g_toMove)<<4,a=g_pieceList[t++];0!=a;){for(o=a-1;0==g_board[o];)e[e.length]=GenerateMove(a,o),o--;for(o=a+1;0==g_board[o];)e[e.length]=GenerateMove(a,o),o++;for(o=a+16;0==g_board[o];)e[e.length]=GenerateMove(a,o),o+=16;for(o=a-16;0==g_board[o];)e[e.length]=GenerateMove(a,o),o-=16;a=g_pieceList[t++]}for(t=(5|g_toMove)<<4,a=g_pieceList[t++];0!=a;){for(o=a-15;0==g_board[o];)e[e.length]=GenerateMove(a,o),o-=15;for(o=a-17;0==g_board[o];)e[e.length]=GenerateMove(a,o),o-=17;for(o=a+15;0==g_board[o];)e[e.length]=GenerateMove(a,o),o+=15;for(o=a+17;0==g_board[o];)e[e.length]=GenerateMove(a,o),o+=17;for(o=a-1;0==g_board[o];)e[e.length]=GenerateMove(a,o),o--;for(o=a+1;0==g_board[o];)e[e.length]=GenerateMove(a,o),o++;for(o=a+16;0==g_board[o];)e[e.length]=GenerateMove(a,o),o+=16;for(o=a-16;0==g_board[o];)e[e.length]=GenerateMove(a,o),o-=16;a=g_pieceList[t++]}if(t=(6|g_toMove)<<4,a=g_pieceList[t],o=a-15,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a-17,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a+15,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a+17,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a-1,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a+1,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a-16,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),o=a+16,0==g_board[o]&&(e[e.length]=GenerateMove(a,o)),!g_inCheck){var r=g_castleRights;g_toMove||(r>>=2),1&r&&g_board[a+1]==pieceEmpty&&g_board[a+2]==pieceEmpty&&(e[e.length]=GenerateMove(a,a+2,moveflagCastleKing)),2&r&&g_board[a-1]==pieceEmpty&&g_board[a-2]==pieceEmpty&&g_board[a-3]==pieceEmpty&&(e[e.length]=GenerateMove(a,a-2,moveflagCastleQueen))}}function GenerateCaptureMoves(e){var a,o,t,r=8==g_toMove?-16:16,i=8==g_toMove?16:8;for(t=(1|g_toMove)<<4,a=g_pieceList[t++];0!=a;)o=a+r-1,g_board[o]&i&&MovePawnTo(e,a,o),o=a+r+1,g_board[o]&i&&MovePawnTo(e,a,o),a=g_pieceList[t++];if(-1!=g_enPassentSquare){var r=g_toMove==colorWhite?-16:16,g=g_toMove|piecePawn,a=g_enPassentSquare-(r+1);(15&g_board[a])==g&&(e[e.length]=GenerateMove(a,g_enPassentSquare,moveflagEPC)),a=g_enPassentSquare-(r-1),(15&g_board[a])==g&&(e[e.length]=GenerateMove(a,g_enPassentSquare,moveflagEPC))}for(t=(2|g_toMove)<<4,a=g_pieceList[t++];0!=a;)o=a+31,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a+33,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a+14,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a-14,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a-31,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a-33,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a+18,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a-18,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),a=g_pieceList[t++];for(t=(3|g_toMove)<<4,a=g_pieceList[t++];0!=a;){o=a;do o-=15;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o-=17;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o+=15;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o+=17;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),a=g_pieceList[t++]}for(t=(4|g_toMove)<<4,a=g_pieceList[t++];0!=a;){o=a;do o--;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o++;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o-=16;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o+=16;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),a=g_pieceList[t++]}for(t=(5|g_toMove)<<4,a=g_pieceList[t++];0!=a;){o=a;do o-=15;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o-=17;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o+=15;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o+=17;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o--;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o++;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o-=16;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a;do o+=16;while(0==g_board[o]);g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),a=g_pieceList[t++]}t=(6|g_toMove)<<4,a=g_pieceList[t],o=a-15,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a-17,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a+15,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a+17,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a-1,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a+1,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a-16,g_board[o]&i&&(e[e.length]=GenerateMove(a,o)),o=a+16,g_board[o]&i&&(e[e.length]=GenerateMove(a,o))}function MovePawnTo(e,a,o){var t=240&o;144==t||32==t?(e[e.length]=GenerateMove(a,o,moveflagPromotion|moveflagPromoteQueen),e[e.length]=GenerateMove(a,o,moveflagPromotion|moveflagPromoteKnight),e[e.length]=GenerateMove(a,o,moveflagPromotion|moveflagPromoteBishop),e[e.length]=GenerateMove(a,o,moveflagPromotion)):e[e.length]=GenerateMove(a,o,0)}function GeneratePawnMoves(e,a){var o=g_board[a],t=o&colorWhite,r=t==colorWhite?-16:16,i=a+r;0==g_board[i]&&(MovePawnTo(e,a,i,pieceEmpty),(48==(240&a)&&t!=colorWhite||128==(240&a)&&t==colorWhite)&&(i+=r,0==g_board[i]&&(e[e.length]=GenerateMove(a,i))))}function UndoHistory(e,a,o,t,r,i,g,n){this.ep=e,this.castleRights=a,this.inCheck=o,this.baseEval=t,this.hashKeyLow=r,this.hashKeyHigh=i,this.move50=g,this.captured=n}function See(e){var a=255&e,o=e>>8&255,t=g_board[a],r=g_seeValues[15&t],i=g_seeValues[15&g_board[o]];if(i>=r)return!0;if(e>>16)return!0;var g=t&colorWhite?colorWhite:0,n=8-g,s=t&colorWhite?-16:16;if((15&g_board[o+s+1])==(piecePawn|n)||(15&g_board[o+s-1])==(piecePawn|n))return!1;var _=new Array,h=r-i;if(SeeAddKnightAttacks(o,n,_),0!=_.length&&h>g_seeValues[pieceKnight])return!1;g_board[a]=0;for(var l=pieceBishop;pieceQueen>=l;l++)if(SeeAddSliderAttacks(o,n,_,l)&&h>g_seeValues[l])return g_board[a]=t,!1;if((15&g_board[o-s+1])==(piecePawn|g)||(15&g_board[o-s-1])==(piecePawn|g))return g_board[a]=t,!0;SeeAddSliderAttacks(o,n,_,pieceKing);var v=new Array;
SeeAddKnightAttacks(o,g,v);for(var l=pieceBishop;pieceKing>=l;l++)SeeAddSliderAttacks(o,g,v,l);g_board[a]=t;for(var c=i-r;;){for(var d=1e3,b=-1,u=0;u<_.length;u++)if(0!=_[u]){var f=g_seeValues[7&g_board[_[u]]];d>f&&(d=f,b=u)}if(-1==b)return!0;if(c+=d,0>c)return!1;var p=_[b];_[b]=0,SeeAddXrayAttack(o,p,g,v,_),d=1e3,b=-1;for(var u=0;u<v.length;u++)if(0!=v[u]){var f=g_seeValues[7&g_board[v[u]]];d>f&&(d=f,b=u)}if(-1==b)return!1;if(c-=d,c>=0)return!0;p=v[b],v[b]=0,SeeAddXrayAttack(o,p,g,v,_)}}function SeeAddXrayAttack(e,a,o,t,r){var i=a-e+128,g=-g_vectorDelta[i].delta;if(0!=g){for(a+=g;0==g_board[a];)a+=g;24&g_board[a]&&IsSquareOnPieceLine(e,a)&&((8&g_board[a])==o?t[t.length]=a:r[r.length]=a)}}function SeeAddKnightAttacks(e,a,o){for(var t=(a|pieceKnight)<<4,r=g_pieceList[t++];0!=r;)IsSquareOnPieceLine(e,r)&&(o[o.length]=r),r=g_pieceList[t++]}function SeeAddSliderAttacks(e,a,o,t){for(var r=(a|t)<<4,i=g_pieceList[r++],g=!1;0!=i;)IsSquareAttackableFrom(e,i)&&(o[o.length]=i,g=!0),i=g_pieceList[r++];return g}function BuildPVMessage(e,a,o,t){var r=g_nodeCount+g_qNodeCount;return"Ply:"+t+" Score:"+a+" Nodes:"+r+" NPS:"+(r/(o/1e3)|0)+" "+PVFromHash(e,15)}function FinishPlyCallback(){}function FinishMoveLocalTesting(e){null!=e&&postMessage(FormatMove(e))}var g_debug=!0,g_timeout=40,g_startTime,g_nodeCount,g_qNodeCount,g_searchValid,g_globalPly=0,minEval=-2e6,maxEval=2e6,minMateBuffer=minEval+2e3,maxMateBuffer=maxEval-2e3,materialTable=[0,800,3350,3450,5e3,9750,6e5],pawnAdj=[0,0,0,0,0,0,0,0,-25,105,135,270,270,135,105,-25,-80,0,30,176,176,30,0,-80,-85,-5,25,175,175,25,-5,-85,-90,-10,20,125,125,20,-10,-90,-95,-15,15,75,75,15,-15,-95,-100,-20,10,70,70,10,-20,-100,0,0,0,0,0,0,0,0],knightAdj=[-200,-100,-50,-50,-50,-50,-100,-200,-100,0,0,0,0,0,0,-100,-50,0,60,60,60,60,0,-50,-50,0,30,60,60,30,0,-50,-50,0,30,60,60,30,0,-50,-50,0,30,30,30,30,0,-50,-100,0,0,0,0,0,0,-100,-200,-50,-25,-25,-25,-25,-50,-200],bishopAdj=[-50,-50,-25,-10,-10,-25,-50,-50,-50,-25,-10,0,0,-10,-25,-50,-25,-10,0,25,25,0,-10,-25,-10,0,25,40,40,25,0,-10,-10,0,25,40,40,25,0,-10,-25,-10,0,25,25,0,-10,-25,-50,-25,-10,0,0,-10,-25,-50,-50,-50,-25,-10,-10,-25,-50,-50],rookAdj=[-60,-30,-10,20,20,-10,-30,-60,40,70,90,120,120,90,70,40,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60],kingAdj=[50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,150,250,75,-25,-25,75,250,150],emptyAdj=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pieceSquareAdj=new Array(8),flipTable=new Array(256),colorBlack=16,colorWhite=8,pieceEmpty=0,piecePawn=1,pieceKnight=2,pieceBishop=3,pieceRook=4,pieceQueen=5,pieceKing=6,g_vectorDelta=new Array(256),g_bishopDeltas=[-15,-17,15,17],g_knightDeltas=[31,33,14,-14,-31,-33,18,-18],g_rookDeltas=[-1,1,-16,16],g_queenDeltas=[-1,1,-15,15,-17,17,-16,16],g_castleRightsMask=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,15,15,15,3,15,15,11,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,13,15,15,15,12,15,15,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],moveflagEPC=2<<16,moveflagCastleKing=4<<16,moveflagCastleQueen=8<<16,moveflagPromotion=16<<16,moveflagPromoteKnight=32<<16,moveflagPromoteQueen=64<<16,moveflagPromoteBishop=8388608,g_board=new Array(256),g_toMove,g_castleRights,g_enPassentSquare,g_baseEval,g_hashKeyLow,g_hashKeyHigh,g_inCheck,g_moveCount=0,g_moveUndoStack=new Array,g_move50=0,g_repMoveStack=new Array,g_hashSize=1<<22,g_hashMask=g_hashSize-1,g_hashTable,g_killers,historyTable=new Array(32),g_zobristLow,g_zobristHigh,g_zobristBlackLow,g_zobristBlackHigh,g_mobUnit,hashflagAlpha=1,hashflagBeta=2,hashflagExact=3,g_pieceIndex=new Array(256),g_pieceList=new Array(256),g_pieceCount=new Array(16),g_seeValues=[0,1,3,3,5,9,900,0,0,1,3,3,5,9,900,0],needsReset=!0;self.onmessage=function(e){if("go"!=e.data&&!needsReset||(ResetGame(),needsReset=!1,"go"!=e.data))if("position"==e.data.match("^position")){ResetGame();{InitializeFromFen(e.data.substr(9,e.data.length-9))}}else"search"==e.data.match("^search")?(g_timeout=parseInt(e.data.substr(7,e.data.length-7),10),Search(FinishMoveLocalTesting,99,FinishPlyCallback)):"analyze"==e.data};
